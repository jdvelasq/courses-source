{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Transacciones ACID (Insert/ Update / Delete) en Hive\n",
    "===\n",
    "\n",
    "* *30 min* | Última modificación: Junio 22, 2019"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "El lenguaje SQL estándar provee directivas para la insertar, actualizar y borrar registros en una tabla. En este tutorial se presentan ejemplos representativos de estas instrucciones en Hive. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "%load_ext bigdata\n",
    "%timeout 300"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Creación de la tabla"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "DROP DATABASE IF EXISTS demo CASCADE;\n",
      "OK\n",
      "Time taken: 5.96 seconds\n",
      "CREATE DATABASE demo;\n",
      "OK\n",
      "Time taken: 0.48 seconds\n",
      "USE demo;\n",
      "OK\n",
      "Time taken: 0.014 seconds\n",
      "CREATE TABLE persons (\n",
      "    id        INT,\n",
      "    firstname STRING,\n",
      "    surname   STRING,\n",
      "    birthday  TIMESTAMP,\n",
      "    quantity  INT\n",
      ")\n",
      "PARTITIONED BY (color STRING)\n",
      "CLUSTERED BY(id) INTO 3 BUCKETS\n",
      "STORED AS ORC \n",
      "LOCATION '/tmp/hive-partitioned'\n",
      "TBLPROPERTIES ('transactional'='true');\n",
      "OK\n",
      "Time taken: 0.508 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "DROP DATABASE IF EXISTS demo CASCADE;\n",
    "CREATE DATABASE demo;\n",
    "USE demo;\n",
    "\n",
    "CREATE TABLE persons (\n",
    "    id        INT,\n",
    "    firstname STRING,\n",
    "    surname   STRING,\n",
    "    birthday  TIMESTAMP,\n",
    "    quantity  INT\n",
    ")\n",
    "PARTITIONED BY (color STRING)\n",
    "CLUSTERED BY(id) INTO 3 BUCKETS\n",
    "STORED AS ORC \n",
    "LOCATION '/tmp/hive-partitioned'\n",
    "TBLPROPERTIES ('transactional'='true');"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Preparación"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Se deben habilitar las características de Hive para manejo de transacciones ACID."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SET hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\n",
      "SET hive.support.concurrency=true;\n",
      "SET hive.enforce.bucketing=true;\n",
      "SET hive.exec.dynamic.partition.mode=nonstrict;\n",
      "SET hive.compactor.initiator.on=true;\n",
      "SET hive.compactor.worker.threads=1;\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SET hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\n",
    "SET hive.support.concurrency=true;\n",
    "SET hive.enforce.bucketing=true;\n",
    "SET hive.exec.dynamic.partition.mode=nonstrict;\n",
    "SET hive.compactor.initiator.on=true;\n",
    "SET hive.compactor.worker.threads=1;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## INSERT\n",
    "\n",
    "    INSERT INTO TABLE tablename VALUES PARTITION () values_row [, values_row ...]\n",
    "    \n",
    "    values_row: \n",
    "       (value [, value ...])\n",
    "       \n",
    "Note que a diferencia de SQL, aca no es posible indicar para que columnas se van a insertar los valores, de tal manera que siempre se deben dar valores para todas las columnas.       "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--\n",
      "-- Inserta el registro en la tabla.\n",
      "-- Los valores est??n en el mismo orden de los campos.\n",
      "--\n",
      "INSERT INTO persons PARTITION (color='green') VALUES\n",
      "    (1,\"Vivian\",\"Hamilton\",\"1971-07-08\",1),\n",
      "    (2,\"Karen\",\"Holcomb\",\"1974-05-23\",4),\n",
      "    (12,\"Hope\",\"Coffey\",\"1973-12-24\",5),\n",
      "    (17,\"Chanda\",\"Boyer\",\"1973-04-01\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108112709_a9562cf2-8654-4a91-b09a-fd8b80db5cd3\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0008, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0008/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0008\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:27:25,014 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:27:32,536 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.38 sec\n",
      "2019-11-08 11:27:42,181 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 5.59 sec\n",
      "2019-11-08 11:27:43,236 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 9.41 sec\n",
      "2019-11-08 11:27:44,293 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 13.01 sec\n",
      "MapReduce Total cumulative CPU time: 13 seconds 10 msec\n",
      "Ended Job = job_1573207742881_0008\n",
      "Loading data to table demo.persons partition (color=green)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 13.01 sec   HDFS Read: 20555 HDFS Write: 2970 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 13 seconds 10 msec\n",
      "OK\n",
      "Time taken: 37.69 seconds\n",
      "INSERT INTO persons PARTITION (color='black') VALUES    \n",
      "    (4,\"Roth\",\"Fry\",\"1975-01-29\",1),\n",
      "    (10,\"Kylan\",\"Sexton\",\"1975-02-28\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108112747_a9040acb-8857-4afb-b2c2-7d72ea27b941\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0009, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0009/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0009\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:28:01,558 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:28:08,951 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.47 sec\n",
      "2019-11-08 11:28:19,614 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 5.37 sec\n",
      "2019-11-08 11:28:20,658 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 8.86 sec\n",
      "2019-11-08 11:28:21,708 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 11.78 sec\n",
      "MapReduce Total cumulative CPU time: 11 seconds 780 msec\n",
      "Ended Job = job_1573207742881_0009\n",
      "Loading data to table demo.persons partition (color=black)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 11.78 sec   HDFS Read: 20557 HDFS Write: 1567 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 11 seconds 780 msec\n",
      "OK\n",
      "Time taken: 36.561 seconds\n",
      "INSERT INTO persons PARTITION (color='blue') VALUES\n",
      "    (5,\"Zoe\",\"Conway\",\"1974-07-03\",2),\n",
      "    (7,\"Driscoll\",\"Klein\",\"1970-10-05\",5),\n",
      "    (15,\"Hope\",\"Silva\",\"1970-07-01\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108112824_2a8dd8c1-8a5b-429e-8a42-0fc51256d00f\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0010, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0010/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0010\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:28:36,862 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:28:45,255 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 3.05 sec\n",
      "2019-11-08 11:28:57,007 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 7.12 sec\n",
      "2019-11-08 11:28:58,082 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 14.66 sec\n",
      "MapReduce Total cumulative CPU time: 14 seconds 660 msec\n",
      "Ended Job = job_1573207742881_0010\n",
      "Loading data to table demo.persons partition (color=blue)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 14.66 sec   HDFS Read: 20581 HDFS Write: 2884 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 14 seconds 660 msec\n",
      "OK\n",
      "Time taken: 36.14 seconds\n",
      "INSERT INTO persons PARTITION (color='orange') VALUES    \n",
      "    (3,\"Cody\",\"Garrett\",\"1973-04-22\",1),\n",
      "    (16,\"Ayanna\",\"Jarvis\",\"1974-02-11\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108112900_bf7dbd6b-13ce-49ec-8ac6-fae0c9ef375f\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0011, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0011/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0011\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:29:14,491 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:29:21,934 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.31 sec\n",
      "2019-11-08 11:29:31,462 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 5.44 sec\n",
      "2019-11-08 11:29:33,528 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 12.42 sec\n",
      "MapReduce Total cumulative CPU time: 12 seconds 420 msec\n",
      "Ended Job = job_1573207742881_0011\n",
      "Loading data to table demo.persons partition (color=orange)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 12.42 sec   HDFS Read: 20586 HDFS Write: 2202 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 12 seconds 420 msec\n",
      "OK\n",
      "Time taken: 35.164 seconds\n",
      "INSERT INTO persons PARTITION (color='violet') VALUES    \n",
      "    (6,\"Gretchen\",\"Kinney\",\"1974-10-18\",1);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108112936_c1e0d4d3-23e9-41e8-907c-98eea81c3549\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0012, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0012/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0012\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:29:50,350 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:29:57,734 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.54 sec\n",
      "2019-11-08 11:30:08,216 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 5.68 sec\n",
      "2019-11-08 11:30:10,296 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 12.39 sec\n",
      "MapReduce Total cumulative CPU time: 12 seconds 390 msec\n",
      "Ended Job = job_1573207742881_0012\n",
      "Loading data to table demo.persons partition (color=violet)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 12.39 sec   HDFS Read: 20550 HDFS Write: 1531 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 12 seconds 390 msec\n",
      "OK\n",
      "Time taken: 36.923 seconds\n",
      "INSERT INTO persons PARTITION (color='red') VALUES    \n",
      "    (8,\"Karyn\",\"Diaz\",\"1969-02-24\",1),\n",
      "    (14,\"Clio\",\"Noel\",\"1972-12-12\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113013_846ea62a-4984-4482-851e-d34386cf875f\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0013, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0013/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0013\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:30:26,374 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:30:34,752 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.4 sec\n",
      "2019-11-08 11:30:45,371 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 6.07 sec\n",
      "2019-11-08 11:30:46,409 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 9.25 sec\n",
      "2019-11-08 11:30:47,451 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 13.0 sec\n",
      "MapReduce Total cumulative CPU time: 13 seconds 0 msec\n",
      "Ended Job = job_1573207742881_0013\n",
      "Loading data to table demo.persons partition (color=red)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 13.0 sec   HDFS Read: 20535 HDFS Write: 1570 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 13 seconds 0 msec\n",
      "OK\n",
      "Time taken: 35.664 seconds\n",
      "INSERT INTO persons PARTITION (color='indigo') VALUES    \n",
      "    (9,\"Merritt\",\"Guy\",\"1974-10-17\",4),\n",
      "    (11,\"Jordan\",\"Estes\",\"1969-12-07\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113049_8416c3fb-13fc-4f00-9537-85fa7ffff037\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0014, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0014/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0014\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:31:02,710 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:31:11,065 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.59 sec\n",
      "2019-11-08 11:31:21,691 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 6.03 sec\n",
      "2019-11-08 11:31:22,746 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 9.77 sec\n",
      "2019-11-08 11:31:24,829 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 13.63 sec\n",
      "MapReduce Total cumulative CPU time: 13 seconds 630 msec\n",
      "Ended Job = job_1573207742881_0014\n",
      "Loading data to table demo.persons partition (color=indigo)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 13.63 sec   HDFS Read: 20584 HDFS Write: 2207 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 13 seconds 630 msec\n",
      "OK\n",
      "Time taken: 37.22 seconds\n",
      "INSERT INTO persons PARTITION (color='gray') VALUES    \n",
      "    (13,\"Vivian\",\"Crane\",\"1970-08-27\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113126_90ccd071-670f-45b3-a813-7f4cbc719a4d\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0015, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0015/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0015\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:31:40,547 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:31:47,876 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.38 sec\n",
      "2019-11-08 11:31:58,442 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 6.04 sec\n",
      "2019-11-08 11:31:59,492 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 9.43 sec\n",
      "2019-11-08 11:32:00,549 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 12.83 sec\n",
      "MapReduce Total cumulative CPU time: 12 seconds 830 msec\n",
      "Ended Job = job_1573207742881_0015\n",
      "Loading data to table demo.persons partition (color=gray)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 12.83 sec   HDFS Read: 20527 HDFS Write: 1520 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 12 seconds 830 msec\n",
      "OK\n",
      "Time taken: 36.646 seconds\n",
      "INSERT INTO persons PARTITION (color='yellow') VALUES\n",
      "    (18,\"Chadwick\",\"Knight\",\"1973-04-29\",1);    \n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113203_aa3fb695-2d94-41f2-bb07-28498a7ed4d3\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0016, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0016/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0016\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-11-08 11:32:16,515 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:32:24,900 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 2.35 sec\n",
      "2019-11-08 11:32:36,553 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 9.85 sec\n",
      "2019-11-08 11:32:37,597 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 12.84 sec\n",
      "MapReduce Total cumulative CPU time: 12 seconds 840 msec\n",
      "Ended Job = job_1573207742881_0016\n",
      "Loading data to table demo.persons partition (color=yellow)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 12.84 sec   HDFS Read: 20560 HDFS Write: 1539 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 12 seconds 840 msec\n",
      "OK\n",
      "Time taken: 36.831 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "--\n",
    "-- Inserta el registro en la tabla.\n",
    "-- Los valores están en el mismo orden de los campos.\n",
    "--\n",
    "INSERT INTO persons PARTITION (color='green') VALUES\n",
    "    (1,\"Vivian\",\"Hamilton\",\"1971-07-08\",1),\n",
    "    (2,\"Karen\",\"Holcomb\",\"1974-05-23\",4),\n",
    "    (12,\"Hope\",\"Coffey\",\"1973-12-24\",5),\n",
    "    (17,\"Chanda\",\"Boyer\",\"1973-04-01\",4);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='black') VALUES    \n",
    "    (4,\"Roth\",\"Fry\",\"1975-01-29\",1),\n",
    "    (10,\"Kylan\",\"Sexton\",\"1975-02-28\",4);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='blue') VALUES\n",
    "    (5,\"Zoe\",\"Conway\",\"1974-07-03\",2),\n",
    "    (7,\"Driscoll\",\"Klein\",\"1970-10-05\",5),\n",
    "    (15,\"Hope\",\"Silva\",\"1970-07-01\",5);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='orange') VALUES    \n",
    "    (3,\"Cody\",\"Garrett\",\"1973-04-22\",1),\n",
    "    (16,\"Ayanna\",\"Jarvis\",\"1974-02-11\",5);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='violet') VALUES    \n",
    "    (6,\"Gretchen\",\"Kinney\",\"1974-10-18\",1);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='red') VALUES    \n",
    "    (8,\"Karyn\",\"Diaz\",\"1969-02-24\",1),\n",
    "    (14,\"Clio\",\"Noel\",\"1972-12-12\",5);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='indigo') VALUES    \n",
    "    (9,\"Merritt\",\"Guy\",\"1974-10-17\",4),\n",
    "    (11,\"Jordan\",\"Estes\",\"1969-12-07\",4);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='gray') VALUES    \n",
    "    (13,\"Vivian\",\"Crane\",\"1970-08-27\",5);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='yellow') VALUES\n",
    "    (18,\"Chadwick\",\"Knight\",\"1973-04-29\",1);    \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons;\n",
      "OK\n",
      "10\tKylan\tSexton\t1975-02-28 00:00:00\t4\tblack\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t5\tred\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t1\tred\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 0.387 seconds, Fetched: 18 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 9 items\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:28 /tmp/hive-partitioned/color=black\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:29 /tmp/hive-partitioned/color=blue\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:32 /tmp/hive-partitioned/color=gray\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:27 /tmp/hive-partitioned/color=green\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:31 /tmp/hive-partitioned/color=indigo\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:29 /tmp/hive-partitioned/color=orange\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:30 /tmp/hive-partitioned/color=red\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:30 /tmp/hive-partitioned/color=violet\n",
      "drwxrwxrwx   - root supergroup          0 2019-11-08 11:32 /tmp/hive-partitioned/color=yellow\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 1 items\n",
      "drwxr-xr-x   - root supergroup          0 2019-11-08 11:28 /tmp/hive-partitioned/color=black/delta_0000002_0000002_0000\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned/color=black"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 3 items\n",
      "-rw-r--r--   1 root supergroup        223 2019-11-08 11:28 /tmp/hive-partitioned/color=black/delta_0000002_0000002_0000/bucket_00000\n",
      "-rw-r--r--   1 root supergroup        929 2019-11-08 11:28 /tmp/hive-partitioned/color=black/delta_0000002_0000002_0000/bucket_00001\n",
      "-rw-r--r--   1 root supergroup        223 2019-11-08 11:28 /tmp/hive-partitioned/color=black/delta_0000002_0000002_0000/bucket_00002\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned/color=black/delta_0000002_0000002_0000"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## UPDATE\n",
    "\n",
    "    UPDATE tablename SET column = value [, column = value ...] [WHERE expression]\n",
    "\n",
    "Véase https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "UPDATE persons SET quantity = 100 WHERE color = 'red';\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113344_07889bb0-e73e-42b4-9cd4-efcb568ecef6\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0017, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0017/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0017\n",
      "Hadoop job information for Stage-1: number of mappers: 3; number of reducers: 3\n",
      "2019-11-08 11:33:54,812 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:34:03,341 Stage-1 map = 67%,  reduce = 0%, Cumulative CPU 4.28 sec\n",
      "2019-11-08 11:34:05,430 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 6.9 sec\n",
      "2019-11-08 11:34:11,807 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 8.85 sec\n",
      "2019-11-08 11:34:12,853 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 13.15 sec\n",
      "MapReduce Total cumulative CPU time: 13 seconds 150 msec\n",
      "Ended Job = job_1573207742881_0017\n",
      "Loading data to table demo.persons partition (color=null)\n",
      "\n",
      "\n",
      "\t Time taken to load dynamic partitions: 0.291 seconds\n",
      "\t Time taken for adding to write entity : 0.0 seconds\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 3  Reduce: 3   Cumulative CPU: 13.15 sec   HDFS Read: 33126 HDFS Write: 1056 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 13 seconds 150 msec\n",
      "OK\n",
      "Time taken: 31.273 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "UPDATE persons SET quantity = 100 WHERE color = 'red';"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons;\n",
      "OK\n",
      "10\tKylan\tSexton\t1975-02-28 00:00:00\t4\tblack\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t100\tred\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t100\tred\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 0.223 seconds, Fetched: 18 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## DELETE\n",
    "\n",
    "    DELETE FROM tablename [WHERE expression]\n",
    "    \n",
    "Véase https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "DELETE FROM persons WHERE id = 10;\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113437_3c66940e-3ce6-4b1e-b10a-5dec6246bdef\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0018, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0018/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0018\n",
      "Hadoop job information for Stage-1: number of mappers: 27; number of reducers: 3\n",
      "2019-11-08 11:34:49,133 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:35:02,037 Stage-1 map = 4%,  reduce = 0%, Cumulative CPU 3.79 sec\n",
      "2019-11-08 11:35:05,274 Stage-1 map = 11%,  reduce = 0%, Cumulative CPU 11.21 sec\n",
      "2019-11-08 11:35:07,442 Stage-1 map = 15%,  reduce = 0%, Cumulative CPU 14.47 sec\n",
      "2019-11-08 11:35:08,528 Stage-1 map = 19%,  reduce = 0%, Cumulative CPU 17.85 sec\n",
      "2019-11-08 11:35:09,579 Stage-1 map = 22%,  reduce = 0%, Cumulative CPU 21.14 sec\n",
      "2019-11-08 11:35:16,094 Stage-1 map = 26%,  reduce = 0%, Cumulative CPU 24.09 sec\n",
      "2019-11-08 11:35:20,465 Stage-1 map = 33%,  reduce = 0%, Cumulative CPU 29.83 sec\n",
      "2019-11-08 11:35:22,596 Stage-1 map = 41%,  reduce = 0%, Cumulative CPU 36.87 sec\n",
      "2019-11-08 11:35:30,265 Stage-1 map = 44%,  reduce = 0%, Cumulative CPU 40.1 sec\n",
      "2019-11-08 11:35:32,380 Stage-1 map = 44%,  reduce = 5%, Cumulative CPU 40.49 sec\n",
      "2019-11-08 11:35:33,404 Stage-1 map = 52%,  reduce = 5%, Cumulative CPU 47.72 sec\n",
      "2019-11-08 11:35:35,533 Stage-1 map = 56%,  reduce = 5%, Cumulative CPU 51.2 sec\n",
      "2019-11-08 11:35:38,783 Stage-1 map = 56%,  reduce = 6%, Cumulative CPU 51.29 sec\n",
      "2019-11-08 11:35:41,999 Stage-1 map = 59%,  reduce = 6%, Cumulative CPU 54.89 sec\n",
      "2019-11-08 11:35:44,133 Stage-1 map = 59%,  reduce = 13%, Cumulative CPU 55.31 sec\n",
      "2019-11-08 11:35:45,179 Stage-1 map = 67%,  reduce = 13%, Cumulative CPU 61.29 sec\n",
      "2019-11-08 11:35:50,424 Stage-1 map = 70%,  reduce = 15%, Cumulative CPU 64.3 sec\n",
      "2019-11-08 11:35:53,605 Stage-1 map = 74%,  reduce = 15%, Cumulative CPU 67.12 sec\n",
      "2019-11-08 11:35:54,644 Stage-1 map = 78%,  reduce = 15%, Cumulative CPU 70.54 sec\n",
      "2019-11-08 11:35:55,725 Stage-1 map = 78%,  reduce = 23%, Cumulative CPU 70.92 sec\n",
      "2019-11-08 11:35:56,810 Stage-1 map = 78%,  reduce = 26%, Cumulative CPU 71.09 sec\n",
      "2019-11-08 11:35:58,927 Stage-1 map = 81%,  reduce = 26%, Cumulative CPU 74.37 sec\n",
      "2019-11-08 11:36:01,039 Stage-1 map = 85%,  reduce = 26%, Cumulative CPU 77.59 sec\n",
      "2019-11-08 11:36:02,104 Stage-1 map = 85%,  reduce = 28%, Cumulative CPU 77.74 sec\n",
      "2019-11-08 11:36:03,108 Stage-1 map = 89%,  reduce = 28%, Cumulative CPU 81.1 sec\n",
      "2019-11-08 11:36:07,328 Stage-1 map = 93%,  reduce = 29%, Cumulative CPU 83.94 sec\n",
      "2019-11-08 11:36:08,396 Stage-1 map = 93%,  reduce = 30%, Cumulative CPU 84.04 sec\n",
      "2019-11-08 11:36:09,436 Stage-1 map = 96%,  reduce = 30%, Cumulative CPU 87.25 sec\n",
      "2019-11-08 11:36:10,496 Stage-1 map = 100%,  reduce = 30%, Cumulative CPU 89.88 sec\n",
      "2019-11-08 11:36:12,582 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 96.27 sec\n",
      "MapReduce Total cumulative CPU time: 1 minutes 36 seconds 270 msec\n",
      "Ended Job = job_1573207742881_0018\n",
      "Loading data to table demo.persons partition (color=null)\n",
      "\n",
      "\n",
      "\t Time taken to load dynamic partitions: 0.192 seconds\n",
      "\t Time taken for adding to write entity : 0.0 seconds\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 27  Reduce: 3   Cumulative CPU: 96.27 sec   HDFS Read: 215526 HDFS Write: 602 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 1 minutes 36 seconds 270 msec\n",
      "OK\n",
      "Time taken: 97.61 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "DELETE FROM persons WHERE id = 10;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons ORDER BY id;\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = root_20191108113615_3bb1226f-a005-4823-878f-39a241961ff0\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 1\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1573207742881_0019, Tracking URL = http://dd8f0caea87b:8088/proxy/application_1573207742881_0019/\n",
      "Kill Command = /usr/local/hadoop/bin/hadoop job  -kill job_1573207742881_0019\n",
      "Hadoop job information for Stage-1: number of mappers: 27; number of reducers: 1\n",
      "2019-11-08 11:36:28,053 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-11-08 11:36:38,657 Stage-1 map = 4%,  reduce = 0%, Cumulative CPU 2.13 sec\n",
      "2019-11-08 11:36:40,840 Stage-1 map = 7%,  reduce = 0%, Cumulative CPU 4.27 sec\n",
      "2019-11-08 11:36:41,908 Stage-1 map = 11%,  reduce = 0%, Cumulative CPU 6.38 sec\n",
      "2019-11-08 11:36:44,023 Stage-1 map = 15%,  reduce = 0%, Cumulative CPU 8.5 sec\n",
      "2019-11-08 11:36:45,087 Stage-1 map = 19%,  reduce = 0%, Cumulative CPU 10.47 sec\n",
      "2019-11-08 11:36:46,144 Stage-1 map = 22%,  reduce = 0%, Cumulative CPU 12.49 sec\n",
      "2019-11-08 11:36:51,563 Stage-1 map = 26%,  reduce = 0%, Cumulative CPU 14.83 sec\n",
      "2019-11-08 11:36:53,747 Stage-1 map = 30%,  reduce = 0%, Cumulative CPU 16.95 sec\n",
      "2019-11-08 11:36:54,834 Stage-1 map = 33%,  reduce = 0%, Cumulative CPU 19.38 sec\n",
      "2019-11-08 11:36:56,988 Stage-1 map = 37%,  reduce = 0%, Cumulative CPU 21.92 sec\n",
      "2019-11-08 11:36:58,050 Stage-1 map = 41%,  reduce = 0%, Cumulative CPU 24.04 sec\n",
      "2019-11-08 11:37:04,414 Stage-1 map = 44%,  reduce = 0%, Cumulative CPU 26.15 sec\n",
      "2019-11-08 11:37:05,479 Stage-1 map = 48%,  reduce = 0%, Cumulative CPU 28.72 sec\n",
      "2019-11-08 11:37:06,535 Stage-1 map = 52%,  reduce = 0%, Cumulative CPU 30.8 sec\n",
      "2019-11-08 11:37:07,603 Stage-1 map = 56%,  reduce = 0%, Cumulative CPU 32.85 sec\n",
      "2019-11-08 11:37:08,699 Stage-1 map = 59%,  reduce = 19%, Cumulative CPU 35.32 sec\n",
      "2019-11-08 11:37:15,210 Stage-1 map = 63%,  reduce = 20%, Cumulative CPU 37.38 sec\n",
      "2019-11-08 11:37:16,306 Stage-1 map = 70%,  reduce = 20%, Cumulative CPU 41.52 sec\n",
      "2019-11-08 11:37:19,497 Stage-1 map = 78%,  reduce = 20%, Cumulative CPU 45.59 sec\n",
      "2019-11-08 11:37:21,651 Stage-1 map = 78%,  reduce = 26%, Cumulative CPU 45.66 sec\n",
      "2019-11-08 11:37:25,955 Stage-1 map = 81%,  reduce = 26%, Cumulative CPU 48.22 sec\n",
      "2019-11-08 11:37:26,997 Stage-1 map = 85%,  reduce = 27%, Cumulative CPU 50.32 sec\n",
      "2019-11-08 11:37:28,044 Stage-1 map = 89%,  reduce = 27%, Cumulative CPU 52.52 sec\n",
      "2019-11-08 11:37:30,174 Stage-1 map = 93%,  reduce = 27%, Cumulative CPU 54.99 sec\n",
      "2019-11-08 11:37:31,228 Stage-1 map = 96%,  reduce = 27%, Cumulative CPU 57.56 sec\n",
      "2019-11-08 11:37:33,311 Stage-1 map = 100%,  reduce = 32%, Cumulative CPU 59.64 sec\n",
      "2019-11-08 11:37:34,353 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 61.62 sec\n",
      "MapReduce Total cumulative CPU time: 1 minutes 1 seconds 620 msec\n",
      "Ended Job = job_1573207742881_0019\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 27  Reduce: 1   Cumulative CPU: 61.62 sec   HDFS Read: 201083 HDFS Write: 1030 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 1 minutes 1 seconds 620 msec\n",
      "OK\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t100\tred\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t100\tred\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 81.227 seconds, Fetched: 17 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons ORDER BY id;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## MERGE\n",
    "\n",
    "    MERGE INTO <target table> AS T USING <source expression/table> AS S\n",
    "    ON <boolean expression1>\n",
    "    WHEN MATCHED [AND <boolean expression2>] THEN UPDATE SET <set clause list>\n",
    "    WHEN MATCHED [AND <boolean expression3>] THEN DELETE\n",
    "    WHEN NOT MATCHED [AND <boolean expression4>] THEN INSERT VALUES<value list>\n",
    "    \n",
    "Véase https://community.hortonworks.com/articles/97113/hive-acid-merge-by-example.html    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "-- limpia la base de datos\n",
      "DROP DATABASE IF EXISTS demo CASCADE;\n",
      "OK\n",
      "Time taken: 0.667 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "-- limpia la base de datos\n",
    "DROP DATABASE IF EXISTS demo CASCADE;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [],
   "source": [
    "!rm *.log"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.8"
  },
  "toc": {
   "base_numbering": 1,
   "nav_menu": {},
   "number_sections": false,
   "sideBar": true,
   "skip_h1_title": true,
   "title_cell": "Table of Contents",
   "title_sidebar": "Contents",
   "toc_cell": false,
   "toc_position": {},
   "toc_section_display": true,
   "toc_window_display": true
  },
  "toc-autonumbering": false
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
