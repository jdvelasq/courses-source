{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Transacciones ACID (Insert/ Update / Delete) en Hive\n",
    "===\n",
    "\n",
    "* *30 min* | Última modificación: Junio 22, 2019"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "El lenguaje SQL estándar provee directivas para la insertar, actualizar y borrar registros en una tabla. En este tutorial se presentan ejemplos representativos de estas instrucciones en Hive. "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "metadata": {},
   "outputs": [],
   "source": [
    "%load_ext bigdata\n",
    "%timeout 300"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Creación de la tabla"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "DROP DATABASE IF EXISTS demo CASCADE;\n",
      "OK\n",
      "Time taken: 8.526 seconds\n",
      "CREATE DATABASE demo;\n",
      "OK\n",
      "Time taken: 0.49 seconds\n",
      "USE demo;\n",
      "OK\n",
      "Time taken: 0.011 seconds\n",
      "CREATE TABLE persons (\n",
      "    id        INT,\n",
      "    firstname STRING,\n",
      "    surname   STRING,\n",
      "    birthday  TIMESTAMP,\n",
      "    quantity  INT\n",
      ")\n",
      "PARTITIONED BY (color STRING)\n",
      "CLUSTERED BY(id) INTO 3 BUCKETS\n",
      "STORED AS ORC \n",
      "LOCATION '/tmp/hive-partitioned'\n",
      "TBLPROPERTIES ('transactional'='true');\n",
      "OK\n",
      "Time taken: 0.539 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "DROP DATABASE IF EXISTS demo CASCADE;\n",
    "CREATE DATABASE demo;\n",
    "USE demo;\n",
    "\n",
    "CREATE TABLE persons (\n",
    "    id        INT,\n",
    "    firstname STRING,\n",
    "    surname   STRING,\n",
    "    birthday  TIMESTAMP,\n",
    "    quantity  INT\n",
    ")\n",
    "PARTITIONED BY (color STRING)\n",
    "CLUSTERED BY(id) INTO 3 BUCKETS\n",
    "STORED AS ORC \n",
    "LOCATION '/tmp/hive-partitioned'\n",
    "TBLPROPERTIES ('transactional'='true');"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Preparación"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "Se deben habilitar las características de Hive para manejo de transacciones ACID."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SET hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\n",
      "SET hive.support.concurrency=true;\n",
      "SET hive.enforce.bucketing=true;\n",
      "SET hive.exec.dynamic.partition.mode=nonstrict;\n",
      "SET hive.compactor.initiator.on=true;\n",
      "SET hive.compactor.worker.threads=1;\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SET hive.txn.manager=org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\n",
    "SET hive.support.concurrency=true;\n",
    "SET hive.enforce.bucketing=true;\n",
    "SET hive.exec.dynamic.partition.mode=nonstrict;\n",
    "SET hive.compactor.initiator.on=true;\n",
    "SET hive.compactor.worker.threads=1;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## INSERT\n",
    "\n",
    "    INSERT INTO TABLE tablename VALUES PARTITION () values_row [, values_row ...]\n",
    "    \n",
    "    values_row: \n",
    "       (value [, value ...])\n",
    "       \n",
    "Note que a diferencia de SQL, aca no es posible indicar para que columnas se van a insertar los valores, de tal manera que siempre se deben dar valores para todas las columnas.       "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "--\n",
      "-- Inserta el registro en la tabla.\n",
      "-- Los valores están en el mismo orden de los campos.\n",
      "--\n",
      "INSERT INTO persons PARTITION (color='green') VALUES\n",
      "    (1,\"Vivian\",\"Hamilton\",\"1971-07-08\",1),\n",
      "    (2,\"Karen\",\"Holcomb\",\"1974-05-23\",4),\n",
      "    (12,\"Hope\",\"Coffey\",\"1973-12-24\",5),\n",
      "    (17,\"Chanda\",\"Boyer\",\"1973-04-01\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124023_1702031a-ab20-4e2d-9aa6-e71950b914aa\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0111, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0111/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0111\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:40:32,541 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:40:38,058 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.67 sec\n",
      "2019-06-07 12:40:43,636 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.07 sec\n",
      "2019-06-07 12:40:44,713 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 6.56 sec\n",
      "2019-06-07 12:40:45,785 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.92 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 920 msec\n",
      "Ended Job = job_1558824450495_0111\n",
      "Loading data to table demo.persons partition (color=green)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.92 sec   HDFS Read: 20564 HDFS Write: 3008 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 920 msec\n",
      "OK\n",
      "Time taken: 24.135 seconds\n",
      "INSERT INTO persons PARTITION (color='black') VALUES    \n",
      "    (4,\"Roth\",\"Fry\",\"1975-01-29\",1),\n",
      "    (10,\"Kylan\",\"Sexton\",\"1975-02-28\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124047_e65ba5b5-7b81-45e7-9789-a2e8590b59ae\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0112, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0112/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0112\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:40:56,574 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:41:00,927 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.6 sec\n",
      "2019-06-07 12:41:07,485 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.15 sec\n",
      "2019-06-07 12:41:09,702 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 7.12 sec\n",
      "2019-06-07 12:41:10,768 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 9.5 sec\n",
      "MapReduce Total cumulative CPU time: 9 seconds 500 msec\n",
      "Ended Job = job_1558824450495_0112\n",
      "Loading data to table demo.persons partition (color=black)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 9.5 sec   HDFS Read: 20575 HDFS Write: 1578 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 9 seconds 500 msec\n",
      "OK\n",
      "Time taken: 24.386 seconds\n",
      "INSERT INTO persons PARTITION (color='blue') VALUES\n",
      "    (5,\"Zoe\",\"Conway\",\"1974-07-03\",2),\n",
      "    (7,\"Driscoll\",\"Klein\",\"1970-10-05\",5),\n",
      "    (15,\"Hope\",\"Silva\",\"1970-07-01\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124112_3e6be5d3-9cb7-4d6e-8889-73edc95fd00a\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0113, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0113/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0113\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:41:21,737 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:41:26,053 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.71 sec\n",
      "2019-06-07 12:41:32,686 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.07 sec\n",
      "2019-06-07 12:41:33,759 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.79 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 790 msec\n",
      "Ended Job = job_1558824450495_0113\n",
      "Loading data to table demo.persons partition (color=blue)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.79 sec   HDFS Read: 20572 HDFS Write: 2917 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 790 msec\n",
      "OK\n",
      "Time taken: 22.788 seconds\n",
      "INSERT INTO persons PARTITION (color='orange') VALUES    \n",
      "    (3,\"Cody\",\"Garrett\",\"1973-04-22\",1),\n",
      "    (16,\"Ayanna\",\"Jarvis\",\"1974-02-11\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124135_4c5d56e3-a86d-4edd-876d-515f70829871\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0114, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0114/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0114\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:41:45,122 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:41:49,420 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.63 sec\n",
      "2019-06-07 12:41:55,967 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.11 sec\n",
      "2019-06-07 12:41:57,026 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 6.63 sec\n",
      "2019-06-07 12:41:58,088 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.76 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 760 msec\n",
      "Ended Job = job_1558824450495_0114\n",
      "Loading data to table demo.persons partition (color=orange)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.76 sec   HDFS Read: 20595 HDFS Write: 2225 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 760 msec\n",
      "OK\n",
      "Time taken: 24.07 seconds\n",
      "INSERT INTO persons PARTITION (color='violet') VALUES    \n",
      "    (6,\"Gretchen\",\"Kinney\",\"1974-10-18\",1);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124159_e18522ab-3080-4e47-b6a6-463d5f32307c\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0115, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0115/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0115\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:42:09,504 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:42:13,785 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.64 sec\n",
      "2019-06-07 12:42:20,404 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.23 sec\n",
      "2019-06-07 12:42:21,475 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 6.53 sec\n",
      "2019-06-07 12:42:22,542 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.65 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 650 msec\n",
      "Ended Job = job_1558824450495_0115\n",
      "Loading data to table demo.persons partition (color=violet)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.65 sec   HDFS Read: 20568 HDFS Write: 1538 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 650 msec\n",
      "OK\n",
      "Time taken: 24.337 seconds\n",
      "INSERT INTO persons PARTITION (color='red') VALUES    \n",
      "    (8,\"Karyn\",\"Diaz\",\"1969-02-24\",1),\n",
      "    (14,\"Clio\",\"Noel\",\"1972-12-12\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124224_f086bb64-984d-4ca3-8007-961d85964a6e\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0116, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0116/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0116\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:42:33,627 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:42:37,967 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.66 sec\n",
      "2019-06-07 12:42:43,422 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 3.45 sec\n",
      "2019-06-07 12:42:44,494 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 5.58 sec\n",
      "2019-06-07 12:42:46,629 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 7.87 sec\n",
      "MapReduce Total cumulative CPU time: 7 seconds 870 msec\n",
      "Ended Job = job_1558824450495_0116\n",
      "Loading data to table demo.persons partition (color=red)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 7.87 sec   HDFS Read: 20544 HDFS Write: 1584 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 7 seconds 870 msec\n",
      "OK\n",
      "Time taken: 23.864 seconds\n",
      "INSERT INTO persons PARTITION (color='indigo') VALUES    \n",
      "    (9,\"Merritt\",\"Guy\",\"1974-10-17\",4),\n",
      "    (11,\"Jordan\",\"Estes\",\"1969-12-07\",4);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124248_e6715129-f9b5-4cd5-864b-31d2a954f7e0\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0117, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0117/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0117\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:42:57,475 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:43:01,811 Stage-1 map = 100%,  reduce = 0%\n",
      "2019-06-07 12:43:08,380 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.04 sec\n",
      "2019-06-07 12:43:09,503 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 4.04 sec\n",
      "2019-06-07 12:43:10,552 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.61 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 610 msec\n",
      "Ended Job = job_1558824450495_0117\n",
      "Loading data to table demo.persons partition (color=indigo)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.61 sec   HDFS Read: 20593 HDFS Write: 2230 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 610 msec\n",
      "OK\n",
      "Time taken: 23.745 seconds\n",
      "INSERT INTO persons PARTITION (color='gray') VALUES    \n",
      "    (13,\"Vivian\",\"Crane\",\"1970-08-27\",5);\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124312_f3b55fca-5a9e-4135-b840-703d20e5caf4\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0118, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0118/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0118\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:43:21,695 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:43:25,928 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.71 sec\n",
      "2019-06-07 12:43:32,452 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 3.95 sec\n",
      "2019-06-07 12:43:33,752 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 6.28 sec\n",
      "2019-06-07 12:43:34,805 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.48 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 480 msec\n",
      "Ended Job = job_1558824450495_0118\n",
      "Loading data to table demo.persons partition (color=gray)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.48 sec   HDFS Read: 20536 HDFS Write: 1532 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 480 msec\n",
      "OK\n",
      "Time taken: 24.139 seconds\n",
      "INSERT INTO persons PARTITION (color='yellow') VALUES\n",
      "    (18,\"Chadwick\",\"Knight\",\"1973-04-29\",1);    \n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124336_d51ffd3b-30a8-4047-96c4-3772e3b4cf6b\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0119, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0119/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0119\n",
      "Hadoop job information for Stage-1: number of mappers: 1; number of reducers: 3\n",
      "2019-06-07 12:43:45,550 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:43:49,873 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 1.69 sec\n",
      "2019-06-07 12:43:56,439 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 4.07 sec\n",
      "2019-06-07 12:43:57,515 Stage-1 map = 100%,  reduce = 67%, Cumulative CPU 6.2 sec\n",
      "2019-06-07 12:43:58,588 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 8.33 sec\n",
      "MapReduce Total cumulative CPU time: 8 seconds 330 msec\n",
      "Ended Job = job_1558824450495_0119\n",
      "Loading data to table demo.persons partition (color=yellow)\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 1  Reduce: 3   Cumulative CPU: 8.33 sec   HDFS Read: 20569 HDFS Write: 1546 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 8 seconds 330 msec\n",
      "OK\n",
      "Time taken: 23.655 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "--\n",
    "-- Inserta el registro en la tabla.\n",
    "-- Los valores están en el mismo orden de los campos.\n",
    "--\n",
    "INSERT INTO persons PARTITION (color='green') VALUES\n",
    "    (1,\"Vivian\",\"Hamilton\",\"1971-07-08\",1),\n",
    "    (2,\"Karen\",\"Holcomb\",\"1974-05-23\",4),\n",
    "    (12,\"Hope\",\"Coffey\",\"1973-12-24\",5),\n",
    "    (17,\"Chanda\",\"Boyer\",\"1973-04-01\",4);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='black') VALUES    \n",
    "    (4,\"Roth\",\"Fry\",\"1975-01-29\",1),\n",
    "    (10,\"Kylan\",\"Sexton\",\"1975-02-28\",4);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='blue') VALUES\n",
    "    (5,\"Zoe\",\"Conway\",\"1974-07-03\",2),\n",
    "    (7,\"Driscoll\",\"Klein\",\"1970-10-05\",5),\n",
    "    (15,\"Hope\",\"Silva\",\"1970-07-01\",5);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='orange') VALUES    \n",
    "    (3,\"Cody\",\"Garrett\",\"1973-04-22\",1),\n",
    "    (16,\"Ayanna\",\"Jarvis\",\"1974-02-11\",5);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='violet') VALUES    \n",
    "    (6,\"Gretchen\",\"Kinney\",\"1974-10-18\",1);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='red') VALUES    \n",
    "    (8,\"Karyn\",\"Diaz\",\"1969-02-24\",1),\n",
    "    (14,\"Clio\",\"Noel\",\"1972-12-12\",5);\n",
    "    \n",
    "INSERT INTO persons PARTITION (color='indigo') VALUES    \n",
    "    (9,\"Merritt\",\"Guy\",\"1974-10-17\",4),\n",
    "    (11,\"Jordan\",\"Estes\",\"1969-12-07\",4);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='gray') VALUES    \n",
    "    (13,\"Vivian\",\"Crane\",\"1970-08-27\",5);\n",
    "\n",
    "INSERT INTO persons PARTITION (color='yellow') VALUES\n",
    "    (18,\"Chadwick\",\"Knight\",\"1973-04-29\",1);    \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons;\n",
      "OK\n",
      "10\tKylan\tSexton\t1975-02-28 00:00:00\t4\tblack\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t5\tred\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t1\tred\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 0.292 seconds, Fetched: 18 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 9 items\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:41 /tmp/hive-partitioned/color=black\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:41 /tmp/hive-partitioned/color=blue\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:43 /tmp/hive-partitioned/color=gray\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:40 /tmp/hive-partitioned/color=green\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:43 /tmp/hive-partitioned/color=indigo\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:41 /tmp/hive-partitioned/color=orange\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:42 /tmp/hive-partitioned/color=red\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:42 /tmp/hive-partitioned/color=violet\n",
      "drwxrwxrwx   - vagrant supergroup          0 2019-06-07 12:44 /tmp/hive-partitioned/color=yellow\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 1 items\n",
      "drwxr-xr-x   - vagrant supergroup          0 2019-06-07 12:41 /tmp/hive-partitioned/color=black/delta_0000026_0000026_0000\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned/color=black"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Found 3 items\n",
      "-rw-r--r--   1 vagrant supergroup        223 2019-06-07 12:41 /tmp/hive-partitioned/color=black/delta_0000026_0000026_0000/bucket_00000\n",
      "-rw-r--r--   1 vagrant supergroup        940 2019-06-07 12:41 /tmp/hive-partitioned/color=black/delta_0000026_0000026_0000/bucket_00001\n",
      "-rw-r--r--   1 vagrant supergroup        223 2019-06-07 12:41 /tmp/hive-partitioned/color=black/delta_0000026_0000026_0000/bucket_00002\n"
     ]
    }
   ],
   "source": [
    "!hdfs dfs -ls /tmp/hive-partitioned/color=black/delta_0000026_0000026_0000"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## UPDATE\n",
    "\n",
    "    UPDATE tablename SET column = value [, column = value ...] [WHERE expression]\n",
    "\n",
    "Véase https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "UPDATE persons SET quantity = 100 WHERE color = 'red';\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124609_a78bda28-0719-40d5-aeae-02076a67d2c6\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0120, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0120/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0120\n",
      "Hadoop job information for Stage-1: number of mappers: 3; number of reducers: 3\n",
      "2019-06-07 12:46:14,724 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:46:20,153 Stage-1 map = 33%,  reduce = 0%, Cumulative CPU 1.74 sec\n",
      "2019-06-07 12:46:21,209 Stage-1 map = 67%,  reduce = 0%, Cumulative CPU 3.38 sec\n",
      "2019-06-07 12:46:22,267 Stage-1 map = 100%,  reduce = 0%, Cumulative CPU 5.38 sec\n",
      "2019-06-07 12:46:26,754 Stage-1 map = 100%,  reduce = 33%, Cumulative CPU 6.99 sec\n",
      "2019-06-07 12:46:27,811 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 10.21 sec\n",
      "MapReduce Total cumulative CPU time: 10 seconds 210 msec\n",
      "Ended Job = job_1558824450495_0120\n",
      "Loading data to table demo.persons partition (color=null)\n",
      "\n",
      "\n",
      "\t Time taken to load dynamic partitions: 0.221 seconds\n",
      "\t Time taken for adding to write entity : 0.001 seconds\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 3  Reduce: 3   Cumulative CPU: 10.21 sec   HDFS Read: 33153 HDFS Write: 1084 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 10 seconds 210 msec\n",
      "OK\n",
      "Time taken: 20.08 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "UPDATE persons SET quantity = 100 WHERE color = 'red';"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons;\n",
      "OK\n",
      "10\tKylan\tSexton\t1975-02-28 00:00:00\t4\tblack\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t100\tred\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t100\tred\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 0.168 seconds, Fetched: 18 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## DELETE\n",
    "\n",
    "    DELETE FROM tablename [WHERE expression]\n",
    "    \n",
    "Véase https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions    "
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "DELETE FROM persons WHERE id = 10;\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124655_41039dd6-fdf7-467d-bd81-ddd51a02037f\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 3\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0121, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0121/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0121\n",
      "Hadoop job information for Stage-1: number of mappers: 27; number of reducers: 3\n",
      "2019-06-07 12:47:00,892 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:47:06,488 Stage-1 map = 4%,  reduce = 0%, Cumulative CPU 2.22 sec\n",
      "2019-06-07 12:47:08,729 Stage-1 map = 7%,  reduce = 0%, Cumulative CPU 4.47 sec\n",
      "2019-06-07 12:47:11,072 Stage-1 map = 11%,  reduce = 0%, Cumulative CPU 6.77 sec\n",
      "2019-06-07 12:47:13,331 Stage-1 map = 15%,  reduce = 0%, Cumulative CPU 9.09 sec\n",
      "2019-06-07 12:47:15,689 Stage-1 map = 19%,  reduce = 0%, Cumulative CPU 11.49 sec\n",
      "2019-06-07 12:47:16,826 Stage-1 map = 22%,  reduce = 0%, Cumulative CPU 13.79 sec\n",
      "2019-06-07 12:47:17,953 Stage-1 map = 30%,  reduce = 0%, Cumulative CPU 18.59 sec\n",
      "2019-06-07 12:47:20,219 Stage-1 map = 33%,  reduce = 0%, Cumulative CPU 20.8 sec\n",
      "2019-06-07 12:47:21,383 Stage-1 map = 37%,  reduce = 0%, Cumulative CPU 23.01 sec\n",
      "2019-06-07 12:47:24,791 Stage-1 map = 41%,  reduce = 0%, Cumulative CPU 25.34 sec\n",
      "2019-06-07 12:47:27,051 Stage-1 map = 48%,  reduce = 0%, Cumulative CPU 29.83 sec\n",
      "2019-06-07 12:47:28,169 Stage-1 map = 52%,  reduce = 0%, Cumulative CPU 32.2 sec\n",
      "2019-06-07 12:47:31,627 Stage-1 map = 56%,  reduce = 0%, Cumulative CPU 34.36 sec\n",
      "2019-06-07 12:47:33,856 Stage-1 map = 59%,  reduce = 0%, Cumulative CPU 36.84 sec\n",
      "2019-06-07 12:47:34,977 Stage-1 map = 67%,  reduce = 7%, Cumulative CPU 41.99 sec\n",
      "2019-06-07 12:47:40,566 Stage-1 map = 70%,  reduce = 15%, Cumulative CPU 44.89 sec\n",
      "2019-06-07 12:47:41,675 Stage-1 map = 78%,  reduce = 15%, Cumulative CPU 49.62 sec\n",
      "2019-06-07 12:47:44,993 Stage-1 map = 81%,  reduce = 15%, Cumulative CPU 51.97 sec\n",
      "2019-06-07 12:47:46,092 Stage-1 map = 85%,  reduce = 16%, Cumulative CPU 54.23 sec\n",
      "2019-06-07 12:47:47,202 Stage-1 map = 89%,  reduce = 18%, Cumulative CPU 56.79 sec\n",
      "2019-06-07 12:47:48,324 Stage-1 map = 89%,  reduce = 28%, Cumulative CPU 57.04 sec\n",
      "2019-06-07 12:47:50,562 Stage-1 map = 93%,  reduce = 28%, Cumulative CPU 59.56 sec\n",
      "2019-06-07 12:47:51,694 Stage-1 map = 93%,  reduce = 29%, Cumulative CPU 59.59 sec\n",
      "2019-06-07 12:47:52,841 Stage-1 map = 100%,  reduce = 30%, Cumulative CPU 64.61 sec\n",
      "2019-06-07 12:47:53,910 Stage-1 map = 100%,  reduce = 77%, Cumulative CPU 67.15 sec\n",
      "2019-06-07 12:47:54,982 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 69.11 sec\n",
      "MapReduce Total cumulative CPU time: 1 minutes 9 seconds 110 msec\n",
      "Ended Job = job_1558824450495_0121\n",
      "Loading data to table demo.persons partition (color=null)\n",
      "\n",
      "\n",
      "\t Time taken to load dynamic partitions: 0.149 seconds\n",
      "\t Time taken for adding to write entity : 0.0 seconds\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 27  Reduce: 3   Cumulative CPU: 69.11 sec   HDFS Read: 216192 HDFS Write: 618 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 1 minutes 9 seconds 110 msec\n",
      "OK\n",
      "Time taken: 60.562 seconds\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "DELETE FROM persons WHERE id = 10;"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "SELECT * FROM persons ORDER BY id;\n",
      "WARNING: Hive-on-MR is deprecated in Hive 2 and may not be available in the future versions. Consider using a different execution engine (i.e. spark, tez) or using Hive 1.X releases.\n",
      "Query ID = vagrant_20190607124801_b7d15cb7-d826-4693-8eff-9714f6d585a2\n",
      "Total jobs = 1\n",
      "Launching Job 1 out of 1\n",
      "Number of reduce tasks determined at compile time: 1\n",
      "In order to change the average load for a reducer (in bytes):\n",
      "  set hive.exec.reducers.bytes.per.reducer=<number>\n",
      "In order to limit the maximum number of reducers:\n",
      "  set hive.exec.reducers.max=<number>\n",
      "In order to set a constant number of reducers:\n",
      "  set mapreduce.job.reduces=<number>\n",
      "Starting Job = job_1558824450495_0122, Tracking URL = http://ubuntu-bionic:8088/proxy/application_1558824450495_0122/\n",
      "Kill Command = /usr/local/hadoop-2.8.5/bin/hadoop job  -kill job_1558824450495_0122\n",
      "Hadoop job information for Stage-1: number of mappers: 27; number of reducers: 1\n",
      "2019-06-07 12:48:08,318 Stage-1 map = 0%,  reduce = 0%\n",
      "2019-06-07 12:48:12,690 Stage-1 map = 4%,  reduce = 0%, Cumulative CPU 1.47 sec\n",
      "2019-06-07 12:48:14,953 Stage-1 map = 7%,  reduce = 0%, Cumulative CPU 3.05 sec\n",
      "2019-06-07 12:48:17,258 Stage-1 map = 11%,  reduce = 0%, Cumulative CPU 4.44 sec\n",
      "2019-06-07 12:48:20,718 Stage-1 map = 15%,  reduce = 0%, Cumulative CPU 5.96 sec\n",
      "2019-06-07 12:48:21,857 Stage-1 map = 22%,  reduce = 0%, Cumulative CPU 8.98 sec\n",
      "2019-06-07 12:48:22,992 Stage-1 map = 30%,  reduce = 0%, Cumulative CPU 12.17 sec\n",
      "2019-06-07 12:48:25,337 Stage-1 map = 33%,  reduce = 0%, Cumulative CPU 13.63 sec\n",
      "2019-06-07 12:48:28,796 Stage-1 map = 37%,  reduce = 0%, Cumulative CPU 15.13 sec\n",
      "2019-06-07 12:48:29,955 Stage-1 map = 41%,  reduce = 0%, Cumulative CPU 16.21 sec\n",
      "2019-06-07 12:48:31,084 Stage-1 map = 44%,  reduce = 0%, Cumulative CPU 17.65 sec\n",
      "2019-06-07 12:48:32,222 Stage-1 map = 48%,  reduce = 0%, Cumulative CPU 19.4 sec\n",
      "2019-06-07 12:48:33,369 Stage-1 map = 52%,  reduce = 0%, Cumulative CPU 21.07 sec\n",
      "2019-06-07 12:48:35,606 Stage-1 map = 56%,  reduce = 0%, Cumulative CPU 22.58 sec\n",
      "2019-06-07 12:48:37,916 Stage-1 map = 59%,  reduce = 0%, Cumulative CPU 24.27 sec\n",
      "2019-06-07 12:48:39,085 Stage-1 map = 63%,  reduce = 0%, Cumulative CPU 25.66 sec\n",
      "2019-06-07 12:48:40,222 Stage-1 map = 67%,  reduce = 0%, Cumulative CPU 27.31 sec\n",
      "2019-06-07 12:48:41,361 Stage-1 map = 70%,  reduce = 22%, Cumulative CPU 29.05 sec\n",
      "2019-06-07 12:48:43,680 Stage-1 map = 74%,  reduce = 22%, Cumulative CPU 30.83 sec\n",
      "2019-06-07 12:48:45,929 Stage-1 map = 81%,  reduce = 22%, Cumulative CPU 34.06 sec\n",
      "2019-06-07 12:48:48,157 Stage-1 map = 85%,  reduce = 27%, Cumulative CPU 35.62 sec\n",
      "2019-06-07 12:48:49,315 Stage-1 map = 89%,  reduce = 27%, Cumulative CPU 37.35 sec\n",
      "2019-06-07 12:48:51,563 Stage-1 map = 96%,  reduce = 27%, Cumulative CPU 40.73 sec\n",
      "2019-06-07 12:48:52,632 Stage-1 map = 100%,  reduce = 27%, Cumulative CPU 42.11 sec\n",
      "2019-06-07 12:48:53,689 Stage-1 map = 100%,  reduce = 100%, Cumulative CPU 43.32 sec\n",
      "MapReduce Total cumulative CPU time: 43 seconds 320 msec\n",
      "Ended Job = job_1558824450495_0122\n",
      "MapReduce Jobs Launched: \n",
      "Stage-Stage-1: Map: 27  Reduce: 1   Cumulative CPU: 43.32 sec   HDFS Read: 201732 HDFS Write: 1030 SUCCESS\n",
      "Total MapReduce CPU Time Spent: 43 seconds 320 msec\n",
      "OK\n",
      "1\tVivian\tHamilton\t1971-07-08 00:00:00\t1\tgreen\n",
      "2\tKaren\tHolcomb\t1974-05-23 00:00:00\t4\tgreen\n",
      "3\tCody\tGarrett\t1973-04-22 00:00:00\t1\torange\n",
      "4\tRoth\tFry\t1975-01-29 00:00:00\t1\tblack\n",
      "5\tZoe\tConway\t1974-07-03 00:00:00\t2\tblue\n",
      "6\tGretchen\tKinney\t1974-10-18 00:00:00\t1\tviolet\n",
      "7\tDriscoll\tKlein\t1970-10-05 00:00:00\t5\tblue\n",
      "8\tKaryn\tDiaz\t1969-02-24 00:00:00\t100\tred\n",
      "9\tMerritt\tGuy\t1974-10-17 00:00:00\t4\tindigo\n",
      "11\tJordan\tEstes\t1969-12-07 00:00:00\t4\tindigo\n",
      "12\tHope\tCoffey\t1973-12-24 00:00:00\t5\tgreen\n",
      "13\tVivian\tCrane\t1970-08-27 00:00:00\t5\tgray\n",
      "14\tClio\tNoel\t1972-12-12 00:00:00\t100\tred\n",
      "15\tHope\tSilva\t1970-07-01 00:00:00\t5\tblue\n",
      "16\tAyanna\tJarvis\t1974-02-11 00:00:00\t5\torange\n",
      "17\tChanda\tBoyer\t1973-04-01 00:00:00\t4\tgreen\n",
      "18\tChadwick\tKnight\t1973-04-29 00:00:00\t1\tyellow\n",
      "Time taken: 54.091 seconds, Fetched: 17 row(s)\n"
     ]
    }
   ],
   "source": [
    "%%hive\n",
    "SELECT * FROM persons ORDER BY id;"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## MERGE\n",
    "\n",
    "    MERGE INTO <target table> AS T USING <source expression/table> AS S\n",
    "    ON <boolean expression1>\n",
    "    WHEN MATCHED [AND <boolean expression2>] THEN UPDATE SET <set clause list>\n",
    "    WHEN MATCHED [AND <boolean expression3>] THEN DELETE\n",
    "    WHEN NOT MATCHED [AND <boolean expression4>] THEN INSERT VALUES<value list>\n",
    "    \n",
    "Véase https://community.hortonworks.com/articles/97113/hive-acid-merge-by-example.html    "
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "---"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": [
    "%%hive\n",
    "-- limpia la base de datos\n",
    "DROP DATABASE IF EXISTS demo CASCADE;"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.8"
  },
  "toc": {
   "base_numbering": 1,
   "nav_menu": {},
   "number_sections": false,
   "sideBar": true,
   "skip_h1_title": true,
   "title_cell": "Table of Contents",
   "title_sidebar": "Contents",
   "toc_cell": false,
   "toc_position": {},
   "toc_section_display": true,
   "toc_window_display": true
  },
  "toc-autonumbering": false
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
