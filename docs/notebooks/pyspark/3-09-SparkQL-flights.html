

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="es" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="es" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Análisis de datos usando PySpark SQL &mdash; documentación de --- Cursos --- - </title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" />
    <link rel="next" title="Pronóstico de la popularidad de libros" href="4-10-MLlib-main-logistic-regression.html" />
    <link rel="prev" title="Operaciones SQL en PySpark" href="3-08-SparkQL.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> --- Cursos ---
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Configuración</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../setup.html">Instalación de Vagrant y Docker</a></li>
</ul>
<p class="caption"><span class="caption-text">Cursos</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../analitica-de-grandes-datos/index.html">Analítica de grandes datos</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../analitica-de-grandes-datos/content.html">Sesiones</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analitica-de-grandes-datos/grades.html">Laboratorios de Programación</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../analitica-de-grandes-datos/course-info.html">Información del curso</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../analitica-financiera/index.html">Analítica Financiera</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analitica-predictiva/index.html">Analítica Predictiva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ciencia-de-los-datos/index.html">Ciencia de los Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fundamentos-de-analitica/index.html">Fundamentos de Analítica</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../productos-de-datos/index.html">Productos de Datos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redes-neuronales-con-tensorflow/index.html">Redes Neuronales Artificiales</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">--- Cursos ---</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../analitica-de-grandes-datos/index.html">Analítica de grandes datos</a> &raquo;</li>
        
          <li><a href="../../analitica-de-grandes-datos/content.html">Sesiones</a> &raquo;</li>
        
      <li>Análisis de datos usando PySpark SQL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/notebooks/pyspark/3-09-SparkQL-flights.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Análisis-de-datos-usando-PySpark-SQL">
<h1>Análisis de datos usando PySpark SQL<a class="headerlink" href="#Análisis-de-datos-usando-PySpark-SQL" title="Enlazar permanentemente con este título">¶</a></h1>
<ul class="simple">
<li><p><em>30 min</em> | Última modificación: Junio 22, 2019</p></li>
</ul>
<p>En este tutorial se presenta el análisis de una base de datos sobre vuelos usando SQL en Spark desde la interfaz de Python. En este documento se ejemplifica el uso de DataFrames para la realización de consultas usando sus funciones nativas, como también el envio de comandos SQL. Adicionalmente, se demuestra como salvar los resultados al HDFS en distintos formatos.</p>
<p>Al finalizar este documento, el lector estará en capacidad de:</p>
<ul class="simple">
<li><p>Mover archivos entre el HDFS y el sistema local.</p></li>
<li><p>Importar tablas en formato CSV a PySpark.</p></li>
<li><p>Aplicar operadores de selección, filtrado y agregación desde Python.</p></li>
<li><p>Usar los resultados obtenidos para construir gráficos.</p></li>
<li><p>Exportar los resultados a archivos en el sistema HDFS.</p></li>
</ul>
<p>Este ejemplo está basado en el tutorial de Spark de HortoWorks, disponible en <a class="reference external" href="https://es.hortonworks.com/tutorial/learning-spark-sql-with-zeppelin/">https://es.hortonworks.com/tutorial/learning-spark-sql-with-zeppelin/</a></p>
<div class="section" id="Descripción-de-los-campos-del-archivo">
<h2>Descripción de los campos del archivo<a class="headerlink" href="#Descripción-de-los-campos-del-archivo" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El archivo usado contiene la información sobre vuelos entre 1987 y 2008, y cuenta con los siguientes campos:</p>
<ul class="simple">
<li><p>Year: 1987-2008</p></li>
<li><p>Month: 1-12</p></li>
<li><p>DayofMonth: 1-31</p></li>
<li><p>DayOfWeek: 1 (Monday) - 7 (Sunday)</p></li>
<li><p>DepTime: actual departure time (local, hhmm)</p></li>
<li><p>CRSDepTime: scheduled departure time (local, hhmm)</p></li>
<li><p>ArrTime: actual arrival time (local, hhmm)</p></li>
<li><p>CRSArrTime: scheduled arrival time (local, hhmm)</p></li>
<li><p>UniqueCarrier: unique carrier code</p></li>
<li><p>FlightNum: flight number</p></li>
<li><p>TailNum: plane tail number</p></li>
<li><p>ActualElapsedTime: in minutes</p></li>
<li><p>CRSElapsedTime: in minutes</p></li>
<li><p>AirTime: in minutes</p></li>
<li><p>ArrDelay: arrival delay, in minutes</p></li>
<li><p>DepDelay: departure delay, in minutes</p></li>
<li><p>Origin: origin IATA airport code</p></li>
<li><p>Dest: destination IATA airport code</p></li>
<li><p>Distance: in miles</p></li>
<li><p>TaxiIn: taxi in time, in minutes</p></li>
<li><p>TaxiOut: taxi out time in minutes</p></li>
<li><p>Cancelled: was the flight cancelled?</p></li>
<li><p>CancellationCode: reason for cancellation (A = carrier, B = weather, C = NAS, D = security)</p></li>
<li><p>Diverted: 1 = yes, 0 = no</p></li>
<li><p>CarrierDelay: in minutes</p></li>
<li><p>WeatherDelay: in minutes</p></li>
<li><p>NASDelay: in minutes</p></li>
<li><p>SecurityDelay: in minutes</p></li>
<li><p>LateAircraftDelay: in minutes</p></li>
</ul>
</div>
<div class="section" id="Preparación">
<h2>Preparación<a class="headerlink" href="#Preparación" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">findspark</span>
<span class="kn">from</span> <span class="nn">pyspark</span> <span class="kn">import</span> <span class="n">SparkConf</span><span class="p">,</span> <span class="n">SparkContext</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="n">findspark</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">sparkConf</span> <span class="o">=</span> <span class="n">SparkConf</span><span class="p">()</span><span class="o">.</span><span class="n">setAppName</span><span class="p">(</span><span class="s2">&quot;Flights SparkQL Application&quot;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">=</span> <span class="n">SparkContext</span><span class="p">(</span><span class="n">conf</span><span class="o">=</span><span class="n">sparkConf</span><span class="p">)</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>wget https://raw.githubusercontent.com/jdvelasq/datalabs/master/datasets/flights.csv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--2019-11-15 00:51:18--  https://raw.githubusercontent.com/jdvelasq/datalabs/master/datasets/flights.csv
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 199.232.48.133
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|199.232.48.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 9719482 (9.3M) [text/plain]
Saving to: &#39;flights.csv.1&#39;

flights.csv.1       100%[===================&gt;]   9.27M  1.47MB/s    in 13s

2019-11-15 00:51:34 (721 KB/s) - &#39;flights.csv.1&#39; saved [9719482/9719482]

</pre></div></div>
</div>
</div>
<div class="section" id="Copia-de-archivos-al-HDFS">
<h2>Copia de archivos al HDFS<a class="headerlink" href="#Copia-de-archivos-al-HDFS" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## El archivo flights.csv se encuentra en la capeta de</span>
<span class="c1">## trabajo de la máquina local. Se copia el archivo</span>
<span class="c1">## a la carpeta /tmp del sistema HDFS.</span>
<span class="c1">##</span>
<span class="o">!</span>hdfs dfs -copyFromLocal flights.csv /tmp/

<span class="c1">##</span>
<span class="c1">## Se listan los archivos en la carpeta /tmp del HDFS</span>
<span class="c1">## para verificar que el archivo haya sido copiado</span>
<span class="c1">##</span>
<span class="o">!</span>hdfs dfs -ls /tmp/*csv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-rw-r--r--   1 root supergroup    9719482 2019-11-15 00:51 /tmp/flights.csv
</pre></div></div>
</div>
</div>
<div class="section" id="Carga-de-datos-en-Spark">
<h2>Carga de datos en Spark<a class="headerlink" href="#Carga-de-datos-en-Spark" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Crea un DataFrame a partir del archivo fligths.csv</span>
<span class="c1">##</span>
<span class="n">flights</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/flights.csv&quot;</span><span class="p">,</span>
                          <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
                          <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
                          <span class="n">inferSchema</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                          <span class="n">header</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se imprime el esquema para verificar la lectura</span>
<span class="c1">## del archivo.</span>
<span class="c1">##</span>
<span class="n">flights</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
root
 |-- Year: integer (nullable = true)
 |-- Month: integer (nullable = true)
 |-- DayofMonth: integer (nullable = true)
 |-- DayOfWeek: integer (nullable = true)
 |-- DepTime: string (nullable = true)
 |-- CRSDepTime: integer (nullable = true)
 |-- ArrTime: string (nullable = true)
 |-- CRSArrTime: integer (nullable = true)
 |-- UniqueCarrier: string (nullable = true)
 |-- FlightNum: integer (nullable = true)
 |-- TailNum: string (nullable = true)
 |-- ActualElapsedTime: string (nullable = true)
 |-- CRSElapsedTime: integer (nullable = true)
 |-- AirTime: string (nullable = true)
 |-- ArrDelay: string (nullable = true)
 |-- DepDelay: string (nullable = true)
 |-- Origin: string (nullable = true)
 |-- Dest: string (nullable = true)
 |-- Distance: integer (nullable = true)
 |-- TaxiIn: string (nullable = true)
 |-- TaxiOut: string (nullable = true)
 |-- Cancelled: integer (nullable = true)
 |-- CancellationCode: string (nullable = true)
 |-- Diverted: integer (nullable = true)
 |-- CarrierDelay: string (nullable = true)
 |-- WeatherDelay: string (nullable = true)
 |-- NASDelay: string (nullable = true)
 |-- SecurityDelay: string (nullable = true)
 |-- LateAircraftDelay: string (nullable = true)

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se imprime un subconjunto de las columnas para verificar</span>
<span class="c1">## la lectura</span>
<span class="c1">##</span>
<span class="n">flights</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;UniqueCarrier&#39;</span><span class="p">,</span> <span class="s1">&#39;FlightNum&#39;</span><span class="p">,</span> <span class="s1">&#39;DepDelay&#39;</span><span class="p">,</span> <span class="s1">&#39;ArrDelay&#39;</span><span class="p">,</span> <span class="s1">&#39;Distance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------+---------+--------+--------+--------+
|UniqueCarrier|FlightNum|DepDelay|ArrDelay|Distance|
+-------------+---------+--------+--------+--------+
|           WN|      335|       8|     -14|     810|
|           WN|     3231|      19|       2|     810|
|           WN|      448|       8|      14|     515|
|           WN|     1746|      -4|      -6|     515|
|           WN|     3920|      34|      34|     515|
+-------------+---------+--------+--------+--------+
only showing top 5 rows

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Número total de registros leidos</span>
<span class="c1">##</span>
<span class="n">numTotalFlights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">numTotalFlights</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
99999
</pre></div></div>
</div>
</div>
<div class="section" id="Cálculos-usando-funciones-de-los-DataFrames">
<h2>Cálculos usando funciones de los DataFrames<a class="headerlink" href="#Cálculos-usando-funciones-de-los-DataFrames" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="Cómputo-del-porcentaje-de-vuelos-retrasados">
<h3>Cómputo del porcentaje de vuelos retrasados<a class="headerlink" href="#Cómputo-del-porcentaje-de-vuelos-retrasados" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## La variable delayedFlights contiene las columnas UniqueCarrier y DepDelay</span>
<span class="c1">## para los vuelos con DepDelay &gt; 15 minutos.</span>
<span class="c1">##</span>
<span class="n">delayedFlights</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;UniqueCarrier&#39;</span><span class="p">,</span> <span class="s1">&#39;DepDelay&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">flights</span><span class="p">[</span><span class="s1">&#39;DepDelay&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">delayedFlights</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------+--------+
|UniqueCarrier|DepDelay|
+-------------+--------+
|           WN|      19|
|           WN|      34|
|           WN|      25|
|           WN|      67|
|           WN|      94|
+-------------+--------+
only showing top 5 rows

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Porcentaje de vuelos retrasados.</span>
<span class="c1">##</span>
<span class="n">numDelayedFlights</span> <span class="o">=</span> <span class="n">delayedFlights</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Porcentaje de vuelos retrasados: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">numDelayedFlights</span> <span class="o">/</span> <span class="n">numTotalFlights</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Porcentaje de vuelos retrasados: 19.58719587195872%
</pre></div></div>
</div>
</div>
<div class="section" id="Creación-de-variables-usando-funciones-de-usuario">
<h3>Creación de variables usando funciones de usuario<a class="headerlink" href="#Creación-de-variables-usando-funciones-de-usuario" title="Enlazar permanentemente con este título">¶</a></h3>
<p>A continuación se desea crear una nueva columna llamada <code class="docutils literal notranslate"><span class="pre">IsDelayed</span></code> que vale 0 si el vuelo se realizó a tiempo y 1 si se retraso. Ya que la nueva columna, es computada como función de otra, se una una función de usuario (o udf) programada en Python.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Esta función se aplicará sobre el DataFrame.</span>
<span class="c1">## El parámetro time será la columna DepDelay</span>
<span class="c1">##</span>
<span class="k">def</span> <span class="nf">is_delayed_py</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">time</span> <span class="o">==</span> <span class="s2">&quot;NA&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<p>A continuación se registra la función en Spark y se aplica sobre el Dataframe.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Importa la función udf que permite registra funciones</span>
<span class="c1">## escritas en Python dentro de Spark</span>
<span class="c1">##</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">udf</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">LongType</span>

<span class="c1">##</span>
<span class="c1">## Se registra la función con el tipo de dato que devuelve.</span>
<span class="c1">## is_delayed_udf corresponde a la función registrada en Spark.</span>
<span class="c1">## Adicionalmente, se indica el tipo de dato que devuelve.</span>
<span class="c1">##</span>
<span class="n">is_delayed_udf</span> <span class="o">=</span> <span class="n">udf</span><span class="p">(</span><span class="n">is_delayed_py</span><span class="p">,</span> <span class="n">LongType</span><span class="p">())</span>

<span class="c1">##</span>
<span class="c1">## Se crea un nuevo DataFrame que contiene la columna</span>
<span class="c1">## IsDelayed, la cual es computada con la udf</span>
<span class="c1">##</span>
<span class="n">flightsWithDelays</span> <span class="o">=</span> <span class="n">flights</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Month&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;DayofMonth&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;UniqueCarrier&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;FlightNum&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;DepDelay&#39;</span><span class="p">,</span>
                                   <span class="n">is_delayed_udf</span><span class="p">(</span><span class="s2">&quot;DepDelay&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;IsDelayed&quot;</span><span class="p">))</span>

<span class="c1">##</span>
<span class="c1">## Se imprimen algunos registros para verificar el resultado.</span>
<span class="c1">##</span>
<span class="n">flightsWithDelays</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;DepDelay&#39;</span><span class="p">,</span> <span class="s1">&#39;isDelayed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------+---------+
|DepDelay|isDelayed|
+--------+---------+
|       8|        0|
|      19|        1|
|       8|        0|
|      -4|        0|
|      34|        1|
|      25|        1|
|      67|        1|
|      -1|        0|
|       2|        0|
|       0|        0|
|       6|        0|
|      94|        1|
|      -4|        0|
|       0|        0|
|       2|        0|
|       9|        0|
|      27|        1|
|       9|        0|
|      28|        1|
|      51|        1|
+--------+---------+
only showing top 20 rows

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## A continuación, se calcula el porcentaje de vuelos con retrasos</span>
<span class="c1">##</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<span class="n">flightsWithDelays</span><span class="o">.</span><span class="n">agg</span><span class="p">((</span><span class="n">F</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;IsDelayed&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">F</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;DepDelay&#39;</span><span class="p">))</span> \
                      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;Porcentaje de vuelos retrasados&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------------------------+
|Porcentaje de vuelos retrasados|
+-------------------------------+
|              19.58719587195872|
+-------------------------------+

</pre></div></div>
</div>
</div>
<div class="section" id="Cómputo-de-los-tiempos-promedio-de-despegue-(Taxi-in)">
<h3>Cómputo de los tiempos promedio de despegue (Taxi-in)<a class="headerlink" href="#Cómputo-de-los-tiempos-promedio-de-despegue-(Taxi-in)" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## En este código se ilustra como computar un promedio</span>
<span class="c1">## y luego realizar el ordenamiento de la tabla por</span>
<span class="c1">## ese mismo promedio.</span>
<span class="c1">##</span>
<span class="p">(</span><span class="n">flights</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;Dest&quot;</span><span class="p">,</span> <span class="s2">&quot;TaxiIn&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;Dest&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s2">&quot;TaxiIn&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;AvgTaxiIn&quot;</span><span class="p">)))</span> \
        <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;AvgTaxiIn&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+------+----+------------------+
|Origin|Dest|         AvgTaxiIn|
+------+----+------------------+
|   CLT| IAH|              22.0|
|   IAH| ABQ|              18.0|
|   MCI| IAH|14.666666666666666|
|   BHM| EWR|              13.0|
|   SMF| GEG|12.462962962962964|
|   MHT| CLE|              12.0|
|   CRW| IAH|              12.0|
|   IAH| JAX|              11.0|
|   ONT| COS|10.903225806451612|
|   SMF| COS|10.610169491525424|
+------+----+------------------+
only showing top 10 rows

</pre></div></div>
</div>
</div>
<div class="section" id="Cómputo-de-los-tiempos-promedio-de-aterrizaje">
<h3>Cómputo de los tiempos promedio de aterrizaje<a class="headerlink" href="#Cómputo-de-los-tiempos-promedio-de-aterrizaje" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## En este código se ilustra como computar un promedio</span>
<span class="c1">## y luego realizar el ordenamiento de la tabla por</span>
<span class="c1">## ese mismo promedio.</span>
<span class="c1">##</span>
<span class="p">(</span><span class="n">flights</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;Dest&quot;</span><span class="p">,</span> <span class="s2">&quot;TaxiOut&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;Origin&quot;</span><span class="p">,</span> <span class="s2">&quot;Dest&quot;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">avg</span><span class="p">(</span><span class="s2">&quot;TaxiOut&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;AvgTaxiOut&quot;</span><span class="p">)))</span> \
        <span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="s2">&quot;AvgTaxiOut&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+------+----+----------+
|Origin|Dest|AvgTaxiOut|
+------+----+----------+
|   LCH| IAH|      84.0|
|   EWR| BHM|      63.0|
|   EWR| SDF|      45.0|
|   EWR| GSO|      36.5|
|   MHT| CLE|      33.0|
|   EWR| JAX|      28.0|
|   EWR| DTW|      27.0|
|   CLE| SDF|      27.0|
|   ORD| EWR|      26.0|
|   EWR| MCI|      26.0|
+------+----+----------+
only showing top 10 rows

</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Cómputos-usando-SQL">
<h2>Cómputos usando SQL<a class="headerlink" href="#Cómputos-usando-SQL" title="Enlazar permanentemente con este título">¶</a></h2>
<p>A continuación se realizan los mismos cálculos anteriores, pero usando SQL desde Spark.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se crea la tabla</span>
<span class="c1">##</span>
<span class="n">flights</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="s1">&#39;flightsView&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se registra la función para usar con Spark SQL</span>
<span class="c1">##</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="n">LongType</span>

<span class="c1">## Registra la función.</span>
<span class="n">spark</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;isDelayed_SQL&#39;</span><span class="p">,</span> <span class="n">is_delayed_py</span><span class="p">)</span>

<span class="c1">## Aplica la función</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    DepDelay,</span>
<span class="s2">    isDelayed_SQL(DepDelay) as isDelayed</span>
<span class="s2">FROM</span>
<span class="s2">    flightsView</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------+---------+
|DepDelay|isDelayed|
+--------+---------+
|       8|        0|
|      19|        1|
|       8|        0|
|      -4|        0|
|      34|        1|
|      25|        1|
|      67|        1|
|      -1|        0|
|       2|        0|
|       0|        0|
|       6|        0|
|      94|        1|
|      -4|        0|
|       0|        0|
|       2|        0|
|       9|        0|
|      27|        1|
|       9|        0|
|      28|        1|
|      51|        1|
+--------+---------+
only showing top 20 rows

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Numero total de retrasos por transportador</span>
<span class="c1">##</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    UniqueCarrier,</span>
<span class="s2">    SUM(isDelayed_SQL(DepDelay)) AS NumDelays</span>
<span class="s2">FROM</span>
<span class="s2">    flightsView</span>
<span class="s2">GROUP BY</span>
<span class="s2">    UniqueCarrier</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------+---------+
|UniqueCarrier|NumDelays|
+-------------+---------+
|           XE|   1014.0|
|           WN|  18573.0|
+-------------+---------+

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    UniqueCarrier,</span>
<span class="s2">    SUM(isDelayed_SQL(DepDelay)) AS NumDelays</span>
<span class="s2">FROM</span>
<span class="s2">    flightsView</span>
<span class="s2">GROUP BY</span>
<span class="s2">    UniqueCarrier</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/notebooks_pyspark_3-09-SparkQL-flights_34_0.png" src="../../_images/notebooks_pyspark_3-09-SparkQL-flights_34_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Tiempo total de retrasos por transportador</span>
<span class="c1">##</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    UniqueCarrier,</span>
<span class="s2">    SUM(DepDelay) AS TotalTimeDelay</span>
<span class="s2">FROM</span>
<span class="s2">    flightsView</span>
<span class="s2">GROUP BY</span>
<span class="s2">    UniqueCarrier</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------+--------------+
|UniqueCarrier|TotalTimeDelay|
+-------------+--------------+
|           XE|       47502.0|
|           WN|      978547.0|
+-------------+--------------+

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Distancia recorrida por operador</span>
<span class="c1">##</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    UniqueCarrier,</span>
<span class="s2">    avg(Distance) AS AvgDistanceTraveled</span>
<span class="s2">FROM</span>
<span class="s2">    flightsView</span>
<span class="s2">GROUP BY</span>
<span class="s2">    UniqueCarrier</span>
<span class="s2">ORDER BY</span>
<span class="s2">    AvgDistanceTraveled DESC</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-------------+-------------------+
|UniqueCarrier|AvgDistanceTraveled|
+-------------+-------------------+
|           XE|  738.0462651413189|
|           WN|  623.7926638668864|
+-------------+-------------------+

</pre></div></div>
</div>
<div class="section" id="Retrasos-por-día-de-la-semana">
<h3>Retrasos por día de la semana<a class="headerlink" href="#Retrasos-por-día-de-la-semana" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    DayOfWeek,</span>
<span class="s2">    delayed,</span>
<span class="s2">    COUNT(1) AS Count</span>
<span class="s2">FROM</span>
<span class="s2">    (SELECT</span>
<span class="s2">        DayOfWeek,</span>
<span class="s2">        isDelayed_SQL(DepDelay) AS delayed</span>
<span class="s2">     FROM</span>
<span class="s2">        flightsView)</span>
<span class="s2">GROUP BY</span>
<span class="s2">    DayOfWeek,</span>
<span class="s2">    delayed</span>
<span class="s2">ORDER BY</span>
<span class="s2">    DayOfWeek</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+---------+-------+-----+
|DayOfWeek|delayed|Count|
+---------+-------+-----+
|        1|      0|11863|
|        1|      1| 2656|
|        2|      1| 1799|
|        2|      0|12910|
|        3|      1| 1434|
|        3|      0|13260|
|        4|      1| 4808|
|        4|      0|12271|
|        5|      1| 3514|
|        5|      0|11003|
|        6|      1| 1878|
|        6|      0| 9407|
|        7|      0| 9698|
|        7|      1| 3498|
+---------+-------+-----+

</pre></div></div>
</div>
</div>
<div class="section" id="Retrasos-por-hora-del-día">
<h3>Retrasos por hora del día<a class="headerlink" href="#Retrasos-por-hora-del-día" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT</span>
<span class="s2">    Hour,</span>
<span class="s2">    delayed,</span>
<span class="s2">    COUNT(1) AS Count</span>
<span class="s2">FROM</span>
<span class="s2">(</span>
<span class="s2">    SELECT</span>
<span class="s2">        CAST(CRSDepTime / 100 AS INT) AS Hour,</span>
<span class="s2">        isDelayed_SQL(DepDelay) AS delayed</span>
<span class="s2">    FROM</span>
<span class="s2">        flightsView</span>
<span class="s2">)</span>
<span class="s2">GROUP BY</span>
<span class="s2">    Hour,</span>
<span class="s2">    delayed</span>
<span class="s2">ORDER BY</span>
<span class="s2">    Hour</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+----+-------+-----+
|Hour|delayed|Count|
+----+-------+-----+
|   6|      1|  208|
|   6|      0| 6126|
|   7|      0| 7274|
|   7|      1|  372|
|   8|      1|  547|
|   8|      0| 5956|
|   9|      1|  761|
|   9|      0| 5861|
|  10|      0| 5783|
|  10|      1|  903|
|  11|      0| 5115|
|  11|      1|  986|
|  12|      1| 1128|
|  12|      0| 5174|
|  13|      1| 1346|
|  13|      0| 5225|
|  14|      0| 4434|
|  14|      1| 1335|
|  15|      0| 4818|
|  15|      1| 1562|
+----+-------+-----+
only showing top 20 rows

</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Almacenamiento-y-lectura-de-tablas-calculadas">
<h2>Almacenamiento y lectura de tablas calculadas<a class="headerlink" href="#Almacenamiento-y-lectura-de-tablas-calculadas" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="section" id="Escritura-de-resultados-en-el-HDFS-con-formato-ORC">
<h3>Escritura de resultados en el HDFS con formato ORC<a class="headerlink" href="#Escritura-de-resultados-en-el-HDFS-con-formato-ORC" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se salva la tabla calculada al directorio tmp del HDFS.</span>
<span class="c1">## Primero se borra si existe.</span>
<span class="c1">##</span>
<span class="o">!</span>hdfs dfs -rm -r -f /tmp/flightsWithDelays.orc

<span class="c1">## Se salva en formato ORC</span>
<span class="n">flightsWithDelays</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;orc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;/tmp/flightsWithDelays.orc&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Contenido del directorio donde se salvó la tabla</span>
<span class="c1">##</span>
<span class="o">!</span>hdfs dfs -ls /tmp/flightsWithDelays.orc
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Found 4 items
-rw-r--r--   1 root supergroup          0 2019-11-15 00:52 /tmp/flightsWithDelays.orc/_SUCCESS
-rw-r--r--   1 root supergroup      89140 2019-11-15 00:52 /tmp/flightsWithDelays.orc/part-00000-86363a17-4ec0-4c5d-8fe1-2bb6d54d18f0-c000.snappy.orc
-rw-r--r--   1 root supergroup     104943 2019-11-15 00:52 /tmp/flightsWithDelays.orc/part-00001-86363a17-4ec0-4c5d-8fe1-2bb6d54d18f0-c000.snappy.orc
-rw-r--r--   1 root supergroup      34305 2019-11-15 00:52 /tmp/flightsWithDelays.orc/part-00002-86363a17-4ec0-4c5d-8fe1-2bb6d54d18f0-c000.snappy.orc
</pre></div></div>
</div>
</div>
<div class="section" id="Carga-de-los-resultados-desde-el-HDFS">
<h3>Carga de los resultados desde el HDFS<a class="headerlink" href="#Carga-de-los-resultados-desde-el-HDFS" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Se lee la tabla calculada desde el HDFS</span>
<span class="c1">##</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;orc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;/tmp/flightsWithDelays.orc&quot;</span><span class="p">)</span>

<span class="c1">## verifica la cantidad de registros.</span>
<span class="k">assert</span> <span class="n">test</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">flightsWithDelays</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Archivos con diferentes tamaños.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Salva-el-DataFrame-como-una-tabla-permamente">
<h3>Salva el DataFrame como una tabla permamente<a class="headerlink" href="#Salva-el-DataFrame-como-una-tabla-permamente" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## La tabla queda guardada en la carpeta</span>
<span class="c1">## spark-warehouse del directorio actual</span>
<span class="c1">##</span>
<span class="o">!</span>rm -rf spark-warehouse/flightswithdelaystbl
<span class="n">flightsWithDelays</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;orc&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="s2">&quot;flightswithdelaystbl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="Tablas-almacenadas">
<h3>Tablas almacenadas<a class="headerlink" href="#Tablas-almacenadas" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SHOW TABLES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------+--------------------+-----------+
|database|           tableName|isTemporary|
+--------+--------------------+-----------+
| default|flightswithdelaystbl|      false|
|        |         flightsview|       true|
+--------+--------------------+-----------+

</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Consultas-en-un-tabla-permanente">
<h2>Consultas en un tabla permanente<a class="headerlink" href="#Consultas-en-un-tabla-permanente" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">##</span>
<span class="c1">## Note que cuando la tabla está almacenada de forma</span>
<span class="c1">## permanente no es necesario cargarla a la memoria</span>
<span class="c1">## para poder usarla.</span>
<span class="c1">##</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(1) AS Total from flightswithdelaystbl&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+-----+
|Total|
+-----+
|99999|
+-----+

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">## Se borran las tablas para limpiar el área</span>
<span class="c1">## de trabajo.</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;DROP TABLE flightswithdelaystbl&quot;</span><span class="p">)</span>
<span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SHOW TABLES&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
+--------+-----------+-----------+
|database|  tableName|isTemporary|
+--------+-----------+-----------+
|        |flightsview|       true|
+--------+-----------+-----------+

</pre></div></div>
</div>
<hr class="docutils" />
<p><strong>Limpieza</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>hdfs dfs -rm /tmp/flights.csv
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
rm: `/tmp/flights.csv&#39;: No such file or directory
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">!</span>rm flights* data.txt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
rm: cannot remove &#39;flights*&#39;: No such file or directory
</pre></div></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Juan D. Velasquez

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>